#!/bin/sh

#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.
#

set -eu

BASE_PKG="github.com/bpg/terraform-provider-proxmox"

usage() {
  cat <<'EOF'
usage: ./testacc [options] [TestName] [-- <go test args...>]

options:
  --env <file>      env file to source (default: testacc.env)
  --pkg <pkg>       override package (example: github.com/bpg/terraform-provider-proxmox/fwprovider/nodes/vm)
  --all             run all fwprovider acceptance tests
  --no-proxy        unset HTTP(S)_PROXY / ALL_PROXY for the test run
  -h, --help        show this help

examples:
  ./testacc TestAccResourceVM2CPU
  ./testacc --no-proxy TestAccResourceVM2CPU
  ./testacc --all
  ./testacc TestAccResourceVM2CPU -- -timeout 10m -count 1
EOF
}

find_test_package() {
    test_name="$1"
    [ -z "$test_name" ] && echo "${BASE_PKG}/fwprovider/..." && return
    
    if command -v rg >/dev/null 2>&1; then
        test_file=$(rg --no-messages --files-with-matches "func ${test_name}\\(" . --glob '*.go' | head -1)
    else
        test_file=$(find . -name "*.go" -type f -exec grep -l "func ${test_name}(" {} \; | head -1)
    fi
    [ -z "$test_file" ] && echo "${BASE_PKG}/fwprovider/..." && return
    
    package_dir=$(dirname "$test_file")
    package_path=$(echo "$package_dir" | sed 's|^\./||')
    echo "${BASE_PKG}/${package_path}"
}

ENV_FILE="testacc.env"
DISABLE_PROXY=0
ALL_PKGS=0
PKG_OVERRIDE=""

while [ $# -gt 0 ]; do
    case "$1" in
        --env)
            [ $# -ge 2 ] || { echo "error: --env requires a value" >&2; exit 2; }
            ENV_FILE="$2"
            shift 2
            ;;
        --pkg)
            [ $# -ge 2 ] || { echo "error: --pkg requires a value" >&2; exit 2; }
            PKG_OVERRIDE="$2"
            shift 2
            ;;
        --all)
            ALL_PKGS=1
            shift
            ;;
        --no-proxy)
            DISABLE_PROXY=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
    esac
done

TEST_NAME=""
if [ $# -gt 0 ] && [ "${1#-}" = "$1" ]; then
    TEST_NAME="$1"
    shift
fi

if [ $# -gt 0 ] && [ "$1" = "--" ]; then
    shift
fi

if [ -f "$ENV_FILE" ]; then
    set -a
    # shellcheck disable=SC1090
    . "./$ENV_FILE"
    set +a
fi

export TF_ACC=1

if [ "$DISABLE_PROXY" -eq 1 ]; then
    unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy ALL_PROXY all_proxy
else
    if [ -n "${HTTP_PROXY-}" ] || [ -n "${HTTPS_PROXY-}" ] || [ -n "${ALL_PROXY-}" ] || [ -n "${http_proxy-}" ] || [ -n "${https_proxy-}" ] || [ -n "${all_proxy-}" ]; then
        base_no_proxy="${NO_PROXY-${no_proxy-}}"

        append_if_missing() {
            value="$1"
            item="$2"

            case ",$value," in
                *,"$item",*) printf '%s' "$value" ;;
                "") printf '%s' "$item" ;;
                *) printf '%s' "$value,$item" ;;
            esac
        }

        base_no_proxy=$(append_if_missing "$base_no_proxy" "127.0.0.1")
        base_no_proxy=$(append_if_missing "$base_no_proxy" "localhost")
        base_no_proxy=$(append_if_missing "$base_no_proxy" "::1")

        export NO_PROXY="$base_no_proxy"
        export no_proxy="$base_no_proxy"
    fi
fi

if [ -n "$PKG_OVERRIDE" ]; then
    PACKAGE_PATH="$PKG_OVERRIDE"
elif [ "$ALL_PKGS" -eq 1 ]; then
    PACKAGE_PATH="${BASE_PKG}/fwprovider/..."
else
    PACKAGE_PATH=$(find_test_package "$TEST_NAME")
fi

if [ -n "$TEST_NAME" ]; then
    go test -count 1 --tags=acceptance -timeout 360s -run "$TEST_NAME" "$@" "$PACKAGE_PATH"
else
    go test -count 1 --tags=acceptance -timeout 360s "$@" "$PACKAGE_PATH"
fi
